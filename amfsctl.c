#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <openssl/md5.h>
#include "amfsctl.h"

int main(int argc, char *argv[])
{
	int ch, ret = 0, PAGE_SIZE = getpagesize();
	int isList = 0, isRemove = 0, isAppend =0, isCipher = 0;
	int fd = -1;
	char buf[PAGE_SIZE];
	char mntpt[400], *pwd;
	unsigned char hash[MD5_DIGEST_LENGTH];

	memset(&buf,0,sizeof(buf));
	memset(&mntpt,0,sizeof(mntpt));

	while((ch = getopt(argc, argv, "la:r:c:h")) != -1) 
	{
		switch(ch)
		{
			case 'l':
				isList = 1;
				break;

			case 'a':
				isAppend = 1;
				strcpy(buf,optarg);				
				break;

			case 'r':
				isRemove = 1;
				strcpy(buf,optarg);				
				break;

			case 'c':
				isCipher = 1;
				pwd = optarg;
				break;

			case 'h':
				fprintf(stdout, "Usage: %s {-l|-a|-r|-c|-h} {pattern | cipher key} mount_point\n", argv[0]);
				fprintf(stdout, "-l : Lists the Pattern Database.\n");
				fprintf(stdout, "-a : Adds pattern to the Database.\n");
				fprintf(stdout, "-r : Removes pattern from Database.\n");
				fprintf(stdout, "-c : Specifies Cipher.\n");
				fprintf(stdout, "-h : Display help message\n");
				fprintf(stdout, "pattern: pattern to be added or removed\n");
				fprintf(stdout, "mount_point: amfs mount point\n");
				return -1;

			case '?':		
				fprintf(stdout, "Invalid Usage! Type amfsct -h for help!\n");				
				goto out;
		}
	}

	if (argc < 3 || argc > 4 || (isCipher == 1 && argc != 4) || (isList == 1 && argc != 3) || (isRemove == 1 && argc != 4) || (isAppend == 1 && argc != 4))
	{
		fprintf(stdout, "Invalid Usage! Type amfsct -h for help!\n");
		goto out;
	}
		

	strcpy(mntpt,argv[optind]);	

	if ((fd = open(mntpt,O_RDONLY)) < 0)
	{
		goto handle_err;		
	}
	
	if (isList == 1)
	{
		ret = ioctl(fd, READ_IOCTL, buf);
		if (ret < 0)
			goto handle_err;

		printf("Pattern Database: \n%s\n", buf);
	}
	else if (isRemove == 1)
	{
		ret = ioctl(fd, REMV_IOCTL, buf);
		if (ret < 0)
			goto handle_err;
	}
	else if (isAppend == 1)
	{
		ret = ioctl(fd, WRITE_IOCTL, buf);
		if (ret < 0)
			goto handle_err;
	}
	else if (isCipher == 1)
	{
		MD5((const unsigned char *)pwd, strlen(pwd), hash);
		ret = ioctl(fd, CIPHER_IOCTL, (char *)hash);

		if (ret < 0)
			goto handle_err;
	}

	return 1;
	

handle_err:

	switch(errno)
	{
		case 17:
				printf ("Pattern: %s already exists!\n", buf);
				break;
		case 61:
				printf ("Pattern: %s not found!\n", buf);
				break;

	}
	perror("Error: ");

out:
	return -1;
}
